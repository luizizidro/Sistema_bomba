<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Sele√ß√£o de Bombas</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sistema de Bombas">
    
    <!-- Performance Optimizations -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- Styles -->
    <link rel="stylesheet" href="src/styles/main.css">
    
    <!-- Critical CSS inlined for better performance -->
    <style>
        /* Critical above-the-fold styles */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <h2>Sistema de Sele√ß√£o de Bombas</h2>
        <p>Carregando recursos otimizados...</p>
        <div id="loadingProgress" style="margin-top: 20px; font-size: 14px; opacity: 0.8;"></div>
    </div>

    <!-- Main Application -->
    <div class="container" style="display: none;" id="mainApp">
        <header class="app-header">
            <h1>Sistema de Sele√ß√£o de Bombas</h1>
            <div class="version-info">v2.0.0 - Otimizado</div>
        </header>
        
        <main class="main-content">
            <section class="chart-section">
                <div class="chart-container">
                    <canvas id="pumpChart" aria-label="Gr√°fico de curvas caracter√≠sticas da bomba"></canvas>
                    <div class="chart-controls">
                        <button id="fullscreenBtn" class="icon-btn" title="Tela cheia">
                            <span>‚õ∂</span>
                        </button>
                        <button id="exportBtn" class="icon-btn" title="Exportar gr√°fico">
                            <span>üìä</span>
                        </button>
                    </div>
                </div>
            </section>
            
            <aside class="control-panel">
                <section class="panel-section">
                    <h3>
                        <span class="section-icon">‚öôÔ∏è</span>
                        Dados da Bomba
                    </h3>
                    <div class="form-group">
                        <label for="pumpSelect">Modelo:</label>
                        <select id="pumpSelect" class="enhanced-select">
                            <option value="BC-21 R 1/2 (3 CV)">BC-21 R 1/2 (3 CV)</option>
                            <option value="BC-21 R 1/2 (4 CV)">BC-21 R 1/2 (4 CV)</option>
                            <option value="Bomba Trabalho">Bomba Trabalho</option>
                        </select>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-card">
                            <span class="info-label">Pot√™ncia</span>
                            <span id="powerInfo" class="info-value">-</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">Rota√ß√£o</span>
                            <span id="rotationInfo" class="info-value">-</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">NPSHr</span>
                            <span id="npshInfo" class="info-value">-</span>
                        </div>
                        <div class="info-card">
                            <span class="info-label">Rendimento</span>
                            <span id="efficiencyInfo" class="info-value">-</span>
                        </div>
                    </div>
                </section>
                
                <section class="panel-section">
                    <h3>
                        <span class="section-icon">üéØ</span>
                        Ponto de Opera√ß√£o
                    </h3>
                    <div class="input-group">
                        <div class="form-group">
                            <label for="flowInput">Vaz√£o (m¬≥/h):</label>
                            <input type="number" id="flowInput" step="0.01" class="enhanced-input" 
                                   placeholder="Ex: 25.5" autocomplete="off">
                            <div class="input-feedback" id="flowFeedback"></div>
                        </div>
                        <div class="form-group">
                            <label for="headInput">Altura (m):</label>
                            <input type="number" id="headInput" step="0.01" class="enhanced-input" 
                                   placeholder="Ex: 30.2" autocomplete="off">
                            <div class="input-feedback" id="headFeedback"></div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button onclick="calculateOperatingPoint()" class="btn btn-primary">
                            <span class="btn-icon">üßÆ</span>
                            Calcular Ponto
                        </button>
                        <button onclick="clearAll()" class="btn btn-secondary">
                            <span class="btn-icon">üóëÔ∏è</span>
                            Limpar
                        </button>
                    </div>
                    
                    <div class="help-text">
                        <p><strong>Dica:</strong> Insira os valores desejados e pressione Enter ou clique em "Calcular Ponto" para ver os resultados no gr√°fico.</p>
                    </div>
                </section>
                
                <section class="panel-section">
                    <h3>
                        <span class="section-icon">üìä</span>
                        Resultados
                    </h3>
                    <div class="results-grid">
                        <div class="result-item">
                            <span class="result-label">Vaz√£o:</span>
                            <span id="flowResult" class="result-value">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Altura:</span>
                            <span id="headResult" class="result-value">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Pot√™ncia:</span>
                            <span id="powerResult" class="result-value">-</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Rendimento:</span>
                            <span id="efficiencyResult" class="result-value">-</span>
                        </div>
                    </div>
                    
                    <div id="statusResult" class="status-message" role="status" aria-live="polite"></div>
                </section>

                <section class="panel-section performance-info">
                    <h3>
                        <span class="section-icon">‚ö°</span>
                        Performance
                    </h3>
                    <div class="performance-metrics">
                        <div class="metric">
                            <span class="metric-label">Cache:</span>
                            <span id="cacheStatus" class="metric-value">Ativo</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Mem√≥ria:</span>
                            <span id="memoryUsage" class="metric-value">Otimizada</span>
                        </div>
                    </div>
                    <button id="optimizeBtn" class="btn btn-outline">
                        <span class="btn-icon">üöÄ</span>
                        Otimizar Sistema
                    </button>
                </section>
            </aside>
        </main>
    </div>

    <!-- Error Fallback -->
    <div id="errorFallback" style="display: none;" class="error-container">
        <h2>‚ùå Erro de Carregamento</h2>
        <p>N√£o foi poss√≠vel carregar os recursos necess√°rios.</p>
        <div class="error-actions">
            <button onclick="location.reload()" class="btn btn-primary">üîÑ Recarregar</button>
            <button onclick="showOfflineMode()" class="btn btn-secondary">üì± Modo Offline</button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Performance monitoring
        const loadStart = performance.now();
        let loadingSteps = 0;
        const totalSteps = 4;

        function updateLoadingProgress(step, message) {
            loadingSteps = step;
            const progress = Math.round((step / totalSteps) * 100);
            const progressEl = document.getElementById('loadingProgress');
            if (progressEl) {
                progressEl.textContent = `${message} (${progress}%)`;
            }
        }

        // Enhanced loading with fallbacks
        async function loadChartJS() {
            updateLoadingProgress(1, 'Carregando Chart.js...');
            
            const cdnUrls = [
                'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js',
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js',
                'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.js'
            ];
            
            for (let i = 0; i < cdnUrls.length; i++) {
                try {
                    await loadScript(cdnUrls[i]);
                    if (typeof Chart !== 'undefined') {
                        console.log(`‚úÖ Chart.js carregado da CDN ${i + 1}`);
                        return true;
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è CDN ${i + 1} falhou:`, error);
                }
            }
            
            throw new Error('Falha ao carregar Chart.js de todas as CDNs');
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.onload = resolve;
                script.onerror = reject;
                
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout'));
                }, 10000);
                
                script.onload = () => {
                    clearTimeout(timeout);
                    resolve();
                };
                
                document.head.appendChild(script);
            });
        }

        async function loadMainScript() {
            updateLoadingProgress(2, 'Carregando sistema principal...');
            
            try {
                // Load as module for better performance
                const module = await import('./src/script.js');
                return module;
            } catch (error) {
                // Fallback to regular script loading
                await loadScript('./src/script.js');
                return window;
            }
        }

        async function initializeApp() {
            try {
                updateLoadingProgress(3, 'Inicializando interface...');
                
                // Load Chart.js
                await loadChartJS();
                
                // Load main application
                const appModule = await loadMainScript();
                
                updateLoadingProgress(4, 'Finalizando...');
                
                // Initialize system
                if (typeof appModule.initializeSystem === 'function') {
                    await appModule.initializeSystem();
                } else if (typeof window.initializeSystem === 'function') {
                    await window.initializeSystem();
                }
                
                // Hide loading screen and show app
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    const loadTime = performance.now() - loadStart;
                    console.log(`üéâ Aplica√ß√£o carregada em ${loadTime.toFixed(2)}ms`);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                showError();
            }
        }

        function showError() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorFallback').style.display = 'block';
        }

        function showOfflineMode() {
            alert('Modo offline n√£o implementado nesta vers√£o. Tente recarregar a p√°gina.');
        }

        // Enhanced features
        function setupEnhancedFeatures() {
            // Fullscreen chart
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', () => {
                    const chartContainer = document.querySelector('.chart-container');
                    if (chartContainer.requestFullscreen) {
                        chartContainer.requestFullscreen();
                    }
                });
            }

            // Export chart
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    const canvas = document.getElementById('pumpChart');
                    if (canvas) {
                        const link = document.createElement('a');
                        link.download = 'curvas-bomba.png';
                        link.href = canvas.toDataURL();
                        link.click();
                    }
                });
            }

            // Optimize system
            const optimizeBtn = document.getElementById('optimizeBtn');
            if (optimizeBtn) {
                optimizeBtn.addEventListener('click', () => {
                    if (typeof window.cleanupMemory === 'function') {
                        window.cleanupMemory();
                        alert('Sistema otimizado com sucesso!');
                    }
                });
            }
        }

        // Start application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeApp();
                setupEnhancedFeatures();
            });
        } else {
            initializeApp();
            setupEnhancedFeatures();
        }

        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registrado:', registration))
                    .catch(error => console.log('SW falhou:', error));
            });
        }
    </script>
</body>
</html>